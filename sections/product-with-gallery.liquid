{%- assign ss = section.settings -%}

{% style %}
/* ===== Base layout ===== */
.section-{{ section.id }} {
  background: {{ ss.background_color | default: '#F3F2F1' }};
}
.section-{{ section.id }} .container {
  max-width: 1280px;
  margin: 0 auto;
  padding: 24px 16px;
  display: grid;
  grid-template-columns: 1.1fr 0.9fr;
  gap: 32px;
}

/* Cologne: image area left, content right */
.product-image-section { position: relative; }
.product-image-section .product-slider { position: relative; }

/* Arrows */
.product-image-section .swiper-button-prev,
.product-image-section .swiper-button-next {
  position: absolute;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  width: 40px;
  height: 40px;
  border-radius: 9999px;
  align-items: center;
  justify-content: center;
  background: rgba(17,17,17,.85);
  color: #fff;
  cursor: pointer;
  z-index: 5;
  border: 1px solid rgba(255,255,255,.15);
}
.product-image-section .swiper-button-prev { left: 8px; }
.product-image-section .swiper-button-next { right: 8px; }

/* Keep visible even if Swiper tries to lock them */
.swiper-button-lock { display: flex !important; }

/* FOUC guard for web component */
swiper-container:not(:defined) > swiper-slide:not(:first-child) { display: none; }
swiper-container:not(:defined) { visibility: hidden; }

/* Main image */
.product-main-image {
  width: 100%;
  height: auto;
  display: block;
  border-radius: 12px;
  overflow: hidden;
  background: #e9e9e9;
}

/* Thumbnails */
.product-thumnail-wrapper { margin-top: 12px; }
.product-thumnail-list {
  display: grid;
  grid-template-columns: repeat(6, minmax(56px, 1fr));
  gap: 8px;
}
.product-thumbnail-item {
  list-style: none;
  border: 1px solid rgba(0,0,0,.08);
  border-radius: 8px;
  overflow: hidden;
  background: #fff;
}
.product-thumbnail-item img {
  display: block;
  width: 100%;
  height: auto;
  aspect-ratio: 1 / 1;
  object-fit: cover;
}

/* ===== Tablet ===== */
@media (max-width: 1024px) {
  .section-{{ section.id }} .container {
    grid-template-columns: 1fr;
    gap: 24px;
    padding: 20px 14px;
  }
  .product-thumnail-list {
    grid-template-columns: repeat(6, minmax(52px, 1fr));
    gap: 6px;
  }
}

/* ===== Mobile ===== */
@media (max-width: 767px) {
  .section-{{ section.id }} .container {
    gap: 16px;
    padding: 16px 12px;
  }
  .product-main-image {
    aspect-ratio: 4 / 5;
    min-height: 320px; /* stabil höjd */
  }
  .product-thumnail-list {
    grid-template-columns: repeat(5, minmax(48px, 1fr));
    gap: 6px;
  }
  .product-image-section .swiper-button-prev,
  .product-image-section .swiper-button-next {
    width: 36px;
    height: 36px;
  }
}
{% endstyle %}

{%- liquid
  assign description_image_blocks = section.blocks | where: 'type', 'description_image'
  assign product_thumbnails = section.blocks | where: 'type', 'product-image'
-%}

<div class="section-{{ section.id }} product-main__content">
  <div class="container">
    <!-- Left: Gallery -->
    <div class="product-image-section">
      <div class="product-slider">
        <swiper-container class="product-image-slider" init="false" data-gallery="main" navigation="false">
          {%- comment -%}
            Bild #1: Om sektionen har en konfigurerad "hero"-bild använd den,
            annars fall-back till produktens första media-bild (image).
          {%- endcomment -%}
          <swiper-slide>
            {%- if ss.media_type == 'image' and ss.image != blank -%}
              <img
                class="product-main-image preview-trigger"
                data-preview-id="0"
                src="{{ ss.image | img_url: '720x', format: 'pjpg' }}"
                srcset="
                  {{ ss.image | img_url: '360x',  format: 'pjpg' }} 360w,
                  {{ ss.image | img_url: '720x',  format: 'pjpg' }} 720w,
                  {{ ss.image | img_url: '1080x', format: 'pjpg' }} 1080w
                "
                sizes="(max-width: 767px) 100vw, (max-width: 1024px) 800px, 1080px"
                width="{{ ss.image.width }}"
                height="{{ ss.image.height }}"
                style="aspect-ratio: {{ ss.image.width }} / {{ ss.image.height }}; object-fit: cover;"
                loading="eager" fetchpriority="high" decoding="async"
              >
            {%- elsif product.featured_media and product.featured_media.preview_image -%}
              <img
                class="product-main-image preview-trigger"
                data-preview-id="0"
                src="{{ product.featured_media | img_url: '720x', format: 'pjpg' }}"
                srcset="
                  {{ product.featured_media | img_url: '360x',  format: 'pjpg' }} 360w,
                  {{ product.featured_media | img_url: '720x',  format: 'pjpg' }} 720w,
                  {{ product.featured_media | img_url: '1080x', format: 'pjpg' }} 1080w
                "
                sizes="(max-width: 767px) 100vw, (max-width: 1024px) 800px, 1080px"
                width="{{ product.featured_media.preview_image.width }}"
                height="{{ product.featured_media.preview_image.height }}"
                style="aspect-ratio: {{ product.featured_media.preview_image.width }} / {{ product.featured_media.preview_image.height }}; object-fit: cover;"
                loading="eager" fetchpriority="high" decoding="async"
              >
            {%- endif -%}
          </swiper-slide>

          {%- comment -%}
            Övriga slides: prioritet på block-bilder om du använder block,
            annars loopa produktens övriga images.
          {%- endcomment -%}
          {%- for b in product_thumbnails -%}
            {%- assign img = b.settings.preview_image -%}
            {%- if img != blank -%}
              <swiper-slide>
                <img
                  class="product-main-image preview-trigger"
                  data-preview-id="{{ forloop.index }}"
                  src="{{ img | img_url: '720x', format: 'pjpg' }}"
                  srcset="
                    {{ img | img_url: '360x',  format: 'pjpg' }} 360w,
                    {{ img | img_url: '720x',  format: 'pjpg' }} 720w,
                    {{ img | img_url: '1080x', format: 'pjpg' }} 1080w
                  "
                  sizes="(max-width: 767px) 100vw, (max-width: 1024px) 800px, 1080px"
                  width="{{ img.width }}"
                  height="{{ img.height }}"
                  style="aspect-ratio: {{ img.width }} / {{ img.height }}; object-fit: cover;"
                  loading="lazy" decoding="async"
                >
              </swiper-slide>
            {%- endif -%}
          {%- endfor -%}

          {%- if product.media.size > 1 and product_thumbnails.size == 0 -%}
            {%- for m in product.media offset: 1 -%}
              {%- if m.media_type == 'image' -%}
                <swiper-slide>
                  <img
                    class="product-main-image preview-trigger"
                    data-preview-id="{{ forloop.index }}"
                    src="{{ m | img_url: '720x', format: 'pjpg' }}"
                    srcset="
                      {{ m | img_url: '360x',  format: 'pjpg' }} 360w,
                      {{ m | img_url: '720x',  format: 'pjpg' }} 720w,
                      {{ m | img_url: '1080x', format: 'pjpg' }} 1080w
                    "
                    sizes="(max-width: 767px) 100vw, (max-width: 1024px) 800px, 1080px"
                    width="{{ m.preview_image.width }}"
                    height="{{ m.preview_image.height }}"
                    style="aspect-ratio: {{ m.preview_image.width }} / {{ m.preview_image.height }}; object-fit: cover;"
                    loading="lazy" decoding="async"
                  >
                </swiper-slide>
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        </swiper-container>

        <!-- Arrows -->
        <button class="swiper-button-prev" type="button" aria-label="Previous"></button>
        <button class="swiper-button-next" type="button" aria-label="Next"></button>
      </div>

      <!-- Thumbnails -->
      <div class="product-thumnail-wrapper">
        <ul class="product-thumnail-list" role="list">
          {%- assign thumb_index = 0 -%}
          {%- if ss.media_type == 'image' and ss.image != blank -%}
            <li class="product-thumbnail-item">
              <img
                src="{{ ss.image | img_url: '300x', format: 'pjpg' }}"
                width="{{ ss.image.width }}"
                height="{{ ss.image.height }}"
                alt="{{ product.title | escape }}"
                loading="lazy" decoding="async">
            </li>
            {%- assign thumb_index = thumb_index | plus: 1 -%}
          {%- elsif product.featured_media and product.featured_media.preview_image -%}
            <li class="product-thumbnail-item">
              <img
                src="{{ product.featured_media | img_url: '300x', format: 'pjpg' }}"
                width="{{ product.featured_media.preview_image.width }}"
                height="{{ product.featured_media.preview_image.height }}"
                alt="{{ product.title | escape }}"
                loading="lazy" decoding="async">
            </li>
            {%- assign thumb_index = thumb_index | plus: 1 -%}
          {%- endif -%}

          {%- for b in product_thumbnails -%}
            {%- assign img = b.settings.preview_image -%}
            {%- if img != blank -%}
              <li class="product-thumbnail-item">
                <img
                  src="{{ img | img_url: '300x', format: 'pjpg' }}"
                  width="{{ img.width }}"
                  height="{{ img.height }}"
                  alt="{{ product.title | escape }}"
                  loading="lazy" decoding="async">
              </li>
            {%- endif -%}
          {%- endfor -%}

          {%- if product.media.size > 1 and product_thumbnails.size == 0 -%}
            {%- for m in product.media offset: 1 -%}
              {%- if m.media_type == 'image' -%}
                <li class="product-thumbnail-item">
                  <img
                    src="{{ m | img_url: '300x', format: 'pjpg' }}"
                    width="{{ m.preview_image.width }}"
                    height="{{ m.preview_image.height }}"
                    alt="{{ product.title | escape }}"
                    loading="lazy" decoding="async">
                </li>
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        </ul>
      </div>
    </div>

    <!-- Right: Product content (titel, pris, köp, etc.) -->
    <div class="product-content">
      {%- comment -%}
        Låt ditt tema/snippet stå för själva köpformuläret så vi inte drar in tunga duplicat.
        Om du har ett snippet som heter 'product-form' använd:
      {%- endcomment -%}
      {%- render 'product-form', product: product, section: section -%}
    </div>
  </div>
</div>

{% schema %}
{
  "name": "Product With Gallery",
  "tag": "section",
  "class": "main-product",
  "settings": [
    {
      "type": "color",
      "id": "background_color",
      "label": "Background",
      "default": "#F3F2F1"
    },
    {
      "type": "header",
      "content": "Hero image (optional)"
    },
    {
      "type": "select",
      "id": "media_type",
      "label": "Media type",
      "default": "image",
      "options": [
        { "label": "Image", "value": "image" }
      ]
    },
    {
      "type": "image_picker",
      "id": "image",
      "label": "Hero image (overrides product featured image)"
    }
  ],
  "blocks": [
    {
      "type": "product-image",
      "name": "Gallery image",
      "limit": 12,
      "settings": [
        { "type": "image_picker", "id": "preview_image", "label": "Image" }
      ]
    },
    { "type": "@app" }
  ],
  "presets": [{ "name": "Product With Gallery" }]
}
{% endschema %}
