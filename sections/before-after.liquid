{%- assign ss = section.settings -%}
<style>
/* --- VISUELL LINJE (divider) --- */
#shopify-section-{{ section.id }} .before-after-slider::before{
  content:"";
  position:absolute; inset:0 auto 0 0;
  left: calc(var(--pos)*100%);
  transform: translateX(-50%);
  width: 2px;
  background: rgba(255,255,255,.95);
  box-shadow: 0 0 0 1px rgba(0,0,0,.08) inset, 0 0 0 1px rgba(0,0,0,.06);
  z-index:4;
  pointer-events:none;
}

/* --- BUBBLAN (handtaget) --- */
#shopify-section-{{ section.id }} .before-after-slider .resizer { 
  position:absolute; inset:0; pointer-events:none; z-index:5;
}
#shopify-section-{{ section.id }} .before-after-slider .resizer-trigger{
  position:absolute; top:50%; left: calc(var(--pos)*100%);
  transform: translate(-50%,-50%);
  width: 44px; height: 44px; border-radius: 9999px;
  background: #fff;
  border: 1px solid rgba(0,0,0,.12);
  box-shadow: 0 6px 18px rgba(0,0,0,.18), 0 1px 2px rgba(0,0,0,.12) inset;
  display:flex; align-items:center; justify-content:center;
  pointer-events:auto; cursor: ew-resize;
}

/* Gör ikonen tydlig mot vit bubbla */
#shopify-section-{{ section.id }} .before-after-slider .resizer-trigger svg{
  width: 18px; height: 18px;
  opacity: .85;
}

/* Säkerställ lagerordning och maskning följer hörnradien */
#shopify-section-{{ section.id }} .before-after-slider{
  position: relative; overflow:hidden; border-radius: {{ ss.image_border_radius }}px; --pos: .5;
}
#shopify-section-{{ section.id }} .before-after-slider .before-image,
#shopify-section-{{ section.id }} .before-after-slider .after-image{
  position:absolute; inset:0;
}
#shopify-section-{{ section.id }} .before-after-slider .after-image{
  clip-path: inset(0 0 0 calc(var(--pos)*100%));
}

  /* Gör lagen ovanpå varandra + handtaget klickbart */
#shopify-section-{{ section.id }} .before-after-slider { position: relative; --pos: .5; }
#shopify-section-{{ section.id }} .before-after-slider .before-image,
#shopify-section-{{ section.id }} .before-after-slider .after-image {
  position: absolute; inset: 0; /* täcker kortet */
}
#shopify-section-{{ section.id }} .before-after-slider .after-image {
  /* visa bara högra delen enligt --pos */
  clip-path: inset(0 0 0 calc(var(--pos)*100%));
}
#shopify-section-{{ section.id }} .before-after-slider .resizer { 
  position: absolute; inset: 0; pointer-events: none; 
}
#shopify-section-{{ section.id }} .before-after-slider .resizer-trigger {
  position: absolute; top: 50%; left: calc(var(--pos)*100%);
  transform: translate(-50%,-50%);
  pointer-events: auto; cursor: ew-resize; z-index: 5;
}

  /* Sektionens container-padding per device */
  @media screen and (min-width: 1025px) {
    #shopify-section-{{ section.id }} .container {
      margin-block: {{ ss.section_top_padding_desktop }}px {{ ss.section_bottom_padding_desktop }}px;
    }
  }
  @media (min-width: 768px) and (max-width: 1024px) {
    #shopify-section-{{ section.id }} .container {
      margin-block: {{ ss.section_top_padding_tablet }}px {{ ss.section_bottom_padding_tablet }}px;
    }
  }
  @media screen and (max-width: 767px) {
    #shopify-section-{{ section.id }} .container {
      margin-block: {{ ss.section_top_padding_mobile }}px {{ ss.section_bottom_padding_mobile }}px;
    }
  }

  /* Grid för flera sliders */
  #shopify-section-{{ section.id }} .sliders {
    display: grid;
    gap: 24px;
  }

  /* Desktop ≥1280px: tre kolumner */
  @media screen and (min-width: 1280px) {
    #shopify-section-{{ section.id }} .sliders {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  /* Laptop 1025–1279px: två kolumner */
  @media screen and (min-width: 1025px) and (max-width: 1279px) {
    #shopify-section-{{ section.id }} .sliders {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  /* Tablet och mobil: en kolumn (default) */

  /* Sliderkort */
  #shopify-section-{{ section.id }} .before-after-slider {
    width: 100%;
    border-radius: {{ ss.image_border_radius }}px;
    overflow: hidden;
    position: relative;
  }
  #shopify-section-{{ section.id }} .before-after-slider img {
    width: 100%;
    height: auto;
    display: block;
  }
</style>

<div class="container">
  {%- if ss.title != blank -%}
    <div class="h2 title">{{ ss.title }}</div>
  {%- endif -%}

  {%- if section.blocks.size > 0 -%}
    <div class="sliders">
      {%- for block in section.blocks -%}
        <div class="before-after-slider" {{ block.shopify_attributes }}>
          {%- if block.settings.image_before != blank and block.settings.image_after != blank -%}
            <div class="before-image">
              {{ block.settings.image_before | image_url: width: 1000 | image_tag: loading: 'lazy' }}
            </div>
            <div class="after-image">
              {{ block.settings.image_after  | image_url: width: 1000 | image_tag: loading: 'lazy' }}
            </div>
            <div class="resizer">
              <div class="resizer-trigger">
                {%- render 'icon', type: 'two-carets' -%}
              </div>
            </div>
          {%- endif -%}
        </div>
      {%- endfor -%}
    </div>
  {%- endif -%}
</div>
<script>
(function() {
  const section = document.getElementById('shopify-section-{{ section.id }}');
  if (!section || section.dataset.beforeAfterInit) return;
  section.dataset.beforeAfterInit = '1';

  const sliders = section.querySelectorAll('.before-after-slider');
  sliders.forEach(initSlider);

  function initSlider(slider){
    const after = slider.querySelector('.after-image');
    const handle = slider.querySelector('.resizer-trigger');
    if(!after || !handle) return;

    let active = false;

    const setPos = (clientX) => {
      const rect = slider.getBoundingClientRect();
      let pct = (clientX - rect.left) / rect.width;
      pct = Math.max(0.02, Math.min(0.98, pct)); // clamp
      slider.style.setProperty('--pos', pct);
      // clip uppdateras av CSS via --pos
    };

    const start = (e) => { active = true; e.preventDefault?.(); };
    const move  = (e) => {
      if(!active) return;
      const touch = e.touches && e.touches[0];
      setPos((touch ? touch.clientX : e.clientX));
    };
    const end   = () => { active = false; };

    handle.addEventListener('mousedown', start);
    handle.addEventListener('touchstart', start, {passive:false});
    window.addEventListener('mousemove', move);
    window.addEventListener('touchmove', move, {passive:false});
    window.addEventListener('mouseup', end);
    window.addEventListener('touchend', end);

    // init i mitten
    const r = slider.getBoundingClientRect();
    setPos(r.left + r.width/2);
  }
})();
</script>

{% schema %}
{
  "name": "Before-After",
  "tag": "section",
  "class": "before-after",
  "settings": [
    { "type": "text", "id": "title", "label": "Title" },
    {
      "type": "range",
      "id": "image_border_radius",
      "label": "Image Border Radius",
      "min": 0, "max": 100, "step": 1, "default": 40, "unit": "px"
    },
    { "type": "header", "content": "Section Padding Settings" },
    { "type": "range", "id": "section_top_padding_desktop", "label": "Top(Desktop)", "min": 0, "max": 160, "step": 4, "default": 120, "unit": "px" },
    { "type": "range", "id": "section_bottom_padding_desktop", "label": "Bottom(Desktop)", "min": 0, "max": 160, "step": 4, "default": 120, "unit": "px" },
    { "type": "range", "id": "section_top_padding_tablet", "label": "Top(Tablet)", "min": 0, "max": 160, "step": 4, "default": 80, "unit": "px" },
    { "type": "range", "id": "section_bottom_padding_tablet", "label": "Bottom(Tablet)", "min": 0, "max": 160, "step": 4, "default": 80, "unit": "px" },
    { "type": "range", "id": "section_top_padding_mobile", "label": "Top(Mobile)", "min": 0, "max": 160, "step": 4, "default": 64, "unit": "px" },
    { "type": "range", "id": "section_bottom_padding_mobile", "label": "Bottom(Mobile)", "min": 0, "max": 160, "step": 4, "default": 64, "unit": "px" }
  ],
  "blocks": [
    {
      "type": "pair",
      "name": "Before/After pair",
      "limit": 3,
      "settings": [
        { "type": "image_picker", "id": "image_before", "label": "Image Before" },
        { "type": "image_picker", "id": "image_after",  "label": "Image After" }
      ]
    }
  ],
  "presets": [
    { "name": "Before-After (up to 3 side-by-side)" }
  ]
}
{% endschema %}
