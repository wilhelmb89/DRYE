{%- assign ss = section.settings -%}
<style>


  /* ===== Grid-layoute ===== */
  #shopify-section-{{ section.id }} .sliders{display:grid;gap:24px}
  @media (min-width:1280px){#shopify-section-{{ section.id }} .sliders{grid-template-columns:repeat(3,minmax(0,1fr))}}
  @media (min-width:1025px) and (max-width:1279px){#shopify-section-{{ section.id }} .sliders{grid-template-columns:repeat(2,minmax(0,1fr))}}

  /* ===== Sektionens padding ===== */
  @media (min-width:1025px){#shopify-section-{{ section.id }} .container{margin-block:{{ ss.section_top_padding_desktop }}px {{ ss.section_bottom_padding_desktop }}px}}
  @media (min-width:768px) and (max-width:1024px){#shopify-section-{{ section.id }} .container{margin-block:{{ ss.section_top_padding_tablet }}px {{ ss.section_bottom_padding_tablet }}px}}
  @media (max-width:767px){#shopify-section-{{ section.id }} .container{margin-block:{{ ss.section_top_padding_mobile }}px {{ ss.section_bottom_padding_mobile }}px}}

  /* ===== Sliderkort ===== */
  #shopify-section-{{ section.id }} .before-after-slider{
    position:relative;
    width:100%;
    overflow:hidden;
    border-radius:{{ ss.image_border_radius }}px;
    --pos:.5; /* start i mitten */
    user-select:none;
    touch-action:none; /* möjliggör drag utan scroll */
  }
  #shopify-section-{{ section.id }} .before-after-slider img{
    width:100%;height:auto;display:block;
    -webkit-user-drag:none;user-drag:none;pointer-events:none;
  }

  /* before = statisk → ger höjd; after = absolut och klipps vid --pos */
  #shopify-section-{{ section.id }} .before-after-slider .before-image{position:relative;z-index:1}
  #shopify-section-{{ section.id }} .before-after-slider .after-image{
    position:absolute;inset:0;z-index:2;
    clip-path:inset(0 0 0 calc(var(--pos)*100%));
  }

  /* Vertikal linje */
  #shopify-section-{{ section.id }} .before-after-slider::before{
    content:"";position:absolute;top:0;bottom:0;left:calc(var(--pos)*100%);
    transform:translateX(-50%);width:2px;background:rgba(255,255,255,.95);
    box-shadow:0 0 0 1px rgba(0,0,0,.06);z-index:3;pointer-events:none;
  }

  /* Overlay + bubbla (knopp) */
  #shopify-section-{{ section.id }} .before-after-slider .resizer{position:absolute;inset:0;z-index:4;pointer-events:none}
  #shopify-section-{{ section.id }} .before-after-slider .resizer-trigger{
    position:absolute;top:50%;left:calc(var(--pos)*100%);transform:translate(-50%,-50%);
    width:46px;height:46px;border-radius:9999px;background:#fff;border:1px solid rgba(0,0,0,.12);
    box-shadow:0 8px 20px rgba(0,0,0,.18), inset 0 1px 2px rgba(0,0,0,.08);
    display:flex;align-items:center;justify-content:center;cursor:ew-resize;
    pointer-events:auto;touch-action:none;padding:0;line-height:1;
  }
  #shopify-section-{{ section.id }} .before-after-slider .resizer-trigger::after{
    content:"";position:absolute;inset:5px;border-radius:inherit;box-shadow:inset 0 0 0 1px rgba(0,0,0,.06)
  }
  #shopify-section-{{ section.id }} .before-after-slider .resizer-trigger svg{width:18px;height:18px;opacity:.8;stroke:#111}
  @media (max-width:767px){#shopify-section-{{ section.id }} .before-after-slider .resizer-trigger{width:40px;height:40px}}

    /* vit linje i mitten */
#shopify-section-{{ section.id }} .before-after-slider::before {
  content: "";
  position: absolute;
  top: 0; bottom: 0;
  left: calc(var(--pos) * 100%);
  transform: translateX(-50%);
  width: 2px;
  background: rgba(255,255,255,.95);
  box-shadow: 0 0 0 1px rgba(0,0,0,.08) inset, 0 0 0 1px rgba(0,0,0,.06);
  z-index: 4;
  pointer-events: none;
}

/* bubblan i mitten */
#shopify-section-{{ section.id }} .before-after-slider .resizer-trigger {
  position: absolute;
  top: 50%;
  left: calc(var(--pos) * 100%);
  transform: translate(-50%, -50%);
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: #fff;
  border: 1px solid rgba(0,0,0,.15);
  box-shadow: 0 4px 12px rgba(0,0,0,.2);
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: ew-resize;
  z-index: 10;
}

/* Slidern är positionerings-ankaret */
.before-after-slider{
  position: relative;
  overflow: hidden;
  border-radius: var(--radius, 40px); /* valfritt */
  --pos: .5;            /* startläge i mitten */
  user-select: none;
  touch-action: none;
}

/* Overlay som täcker hela kortet */
.before-after-slider .resizer{
  position: absolute;
  inset: 0;
  z-index: 4;
  pointer-events: none; /* tillåt klick bara på knoppen */
}

/* Vita knoppen – positioneras relativt slidern via --pos */
.before-after-slider .resizer-trigger{
  position: absolute;
  top: 50%;
  left: calc(var(--pos) * 100%);
  transform: translate(-50%, -50%);
  width: 46px; height: 46px;
  border-radius: 9999px;
  background: #fff;
  border: 1px solid rgba(0,0,0,.12);
  box-shadow: 0 8px 20px rgba(0,0,0,.18), inset 0 1px 2px rgba(0,0,0,.08);
  display: flex; align-items: center; justify-content: center;
  cursor: ew-resize;
  pointer-events: auto;  /* gör knoppen dragbar */
  padding: 0;
  line-height: 1;
  -webkit-appearance: none;
  appearance: none;
}

/* Den vita linjen i mitten */
.before-after-slider::before{
  content: "";
  position: absolute;
  top: 0; bottom: 0;
  left: calc(var(--pos) * 100%);
  transform: translateX(-50%);
  width: 2px;
  background: rgba(255,255,255,.95);
  box-shadow: 0 0 0 1p

</style>

<div class="container">
  {%- if ss.title != blank -%}
    <div class="h2 title">{{ ss.title }}</div>
  {%- endif -%}

  {%- if section.blocks.size > 0 -%}
    <div class="sliders">
      {%- for block in section.blocks -%}
        <div class="before-after-slider" {{ block.shopify_attributes }}>
          {%- if block.settings.image_before != blank and block.settings.image_after != blank -%}
            <div class="before-image">
              {{ block.settings.image_before | image_url: width: 1400 | image_tag: loading: 'lazy' }}
            </div>
            <div class="after-image">
              {{ block.settings.image_after  | image_url: width: 1400 | image_tag: loading: 'lazy' }}
            </div>
            <div class="resizer">
              <button class="resizer-trigger" type="button" aria-label="Drag to compare">
                {%- render 'icon', type: 'two-carets' -%}
              </button>
            </div>
          {%- endif -%}
        </div>
      {%- endfor -%}
    </div>
  {%- endif -%}
</div>

<script>
(function(){
  const section = document.getElementById('shopify-section-{{ section.id }}');
  if(!section || section.dataset.beforeAfterInit) return;
  section.dataset.beforeAfterInit = '1';

  section.querySelectorAll('.before-after-slider').forEach((slider)=>{
    const handle = slider.querySelector('.resizer-trigger');

    const setPos = (x)=>{
      const r = slider.getBoundingClientRect();
      let p = (x - r.left) / r.width;
      p = Math.max(0.02, Math.min(0.98, p));
      slider.style.setProperty('--pos', p);
    };

    const onPointerDown = (e)=>{
      e.preventDefault();
      const capturer = slider;               // dra var som helst i slidern
      capturer.setPointerCapture(e.pointerId);
      setPos(e.clientX);
      const move = ev => setPos(ev.clientX);
      const up = ev =>{
        capturer.releasePointerCapture(ev.pointerId);
        capturer.removeEventListener('pointermove', move);
        capturer.removeEventListener('pointerup', up);
        capturer.removeEventListener('pointercancel', up);
      };
      capturer.addEventListener('pointermove', move);
      capturer.addEventListener('pointerup', up);
      capturer.addEventListener('pointercancel', up);
    };

    // lyssna på hela slidern (inkl. bubblan)
    slider.addEventListener('pointerdown', onPointerDown);

    // init i mitten
    const r = slider.getBoundingClientRect();
    setPos(r.left + r.width/2);
  });
})();
</script>

{% schema %}
{
  "name": "Before-After",
  "tag": "section",
  "class": "before-after",
  "settings": [
    { "type": "text", "id": "title", "label": "Title" },
    { "type": "range", "id": "image_border_radius", "label": "Image Border Radius", "min": 0, "max": 100, "step": 1, "default": 40, "unit": "px" },
    { "type": "header", "content": "Section Padding Settings" },
    { "type": "range", "id": "section_top_padding_desktop", "label": "Top(Desktop)", "min": 0, "max": 160, "step": 4, "default": 120, "unit": "px" },
    { "type": "range", "id": "section_bottom_padding_desktop", "label": "Bottom(Desktop)", "min": 0, "max": 160, "step": 4, "default": 120, "unit": "px" },
    { "type": "range", "id": "section_top_padding_tablet", "label": "Top(Tablet)", "min": 0, "max": 160, "step": 4, "default": 80, "unit": "px" },
    { "type": "range", "id": "section_bottom_padding_tablet", "label": "Bottom(Tablet)", "min": 0, "max": 160, "step": 4, "default": 80, "unit": "px" },
    { "type": "range", "id": "section_top_padding_mobile", "label": "Top(Mobile)", "min": 0, "max": 160, "step": 4, "default": 64, "unit": "px" },
    { "type": "range", "id": "section_bottom_padding_mobile", "label": "Bottom(Mobile)", "min": 0, "max": 160, "step": 4, "default": 64, "unit": "px" }
  ],
  "blocks": [
    {
      "type": "pair",
      "name": "Before/After pair",
      "limit": 3,
      "settings": [
        { "type": "image_picker", "id": "image_before", "label": "Image Before" },
        { "type": "image_picker", "id": "image_after", "label": "Image After" }
      ]
    }
  ],
  "presets": [{ "name": "Before-After (up to 3 side-by-side)" }]
}
{% endschema %}
