{%- assign ss = section.settings -%}
<style>

  @media (max-width: 767px) {
  .section-{{ section.id }} h2.title {
    font-size: 28px !important;
    line-height: 32px !important;
    letter-spacing: -0.02em;
  }
}
  /* Sektionens container-padding per device */
  @media screen and (min-width: 1025px) {
    #shopify-section-{{ section.id }} .container {
      margin-block: {{ ss.section_top_padding_desktop }}px {{ ss.section_bottom_padding_desktop }}px;
    }
  }
  @media (min-width: 768px) and (max-width: 1024px) {
    #shopify-section-{{ section.id }} .container {
      margin-block: {{ ss.section_top_padding_tablet }}px {{ ss.section_bottom_padding_tablet }}px;
    }
  }
  @media screen and (max-width: 767px) {
    #shopify-section-{{ section.id }} .container {
      margin-block: {{ ss.section_top_padding_mobile }}px {{ ss.section_bottom_padding_mobile }}px;
    }
  }

  /* Grid för flera sliders */
  #shopify-section-{{ section.id }} .sliders {
    display: grid;
    gap: 24px;
  }

  /* Desktop ≥1280px: tre kolumner */
  @media screen and (min-width: 1280px) {
    #shopify-section-{{ section.id }} .sliders {
      grid-template-columns: repeat(3, minmax(0, 1fr));
    }
  }

  /* Laptop 1025–1279px: två kolumner */
  @media screen and (min-width: 1025px) and (max-width: 1279px) {
    #shopify-section-{{ section.id }} .sliders {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  /* Tablet och mobil: en kolumn (default) */

  /* Sliderkort */
  #shopify-section-{{ section.id }} .before-after-slider {
    width: 100%;
    border-radius: {{ ss.image_border_radius }}px;
    overflow: hidden;
    position: relative;
  }
  #shopify-section-{{ section.id }} .before-after-slider img {
    width: 100%;
    height: auto;
    display: block;
  }

 /* === DRAG — EN ENDA SANNING === */

/* startläge + ankare */
#shopify-section-{{ section.id }} .before-after-slider{
  position: relative;
  overflow: hidden;
  --pos: .5;               /* start i mitten */
  + touch-action: pan-y;     /* tillåt vertikal scroll; vi fångar bara horisontellt drag i JS */
}

/* lager: before ger höjd; after klipps av --pos */
#shopify-section-{{ section.id }} .before-after-slider .before-image{ position: relative; z-index: 1; }
#shopify-section-{{ section.id }} .before-after-slider .after-image{
  position: absolute; inset: 0; z-index: 2;
  clip-path: inset(0 0 0 calc(var(--pos) * 100%));
}

/* vit mittlinje UNDER knoppen */
#shopify-section-{{ section.id }} .before-after-slider::before{
  content:""; position:absolute; top:0; bottom:0;
  left: calc(var(--pos) * 100%); transform: translateX(-50%);
  width:2px; background: rgba(255,255,255,.95);
  box-shadow: 0 0 0 1px rgba(0,0,0,.08) inset, 0 0 0 1px rgba(0,0,0,.06);
  z-index: 5; pointer-events:none;
}

/* overlay som inte blockerar pekhändelser */
#shopify-section-{{ section.id }} .before-after-slider .resizer{
  position: static;           /* viktigt: gör knoppen relativ .before-after-slider */
  pointer-events: none;       /* blockera inte drag */
  overflow: visible;
}

/* KNOPPEN – överst, klickbar */
#shopify-section-{{ section.id }} .before-after-slider .resizer-trigger{
  position:absolute; top:50%; left: calc(var(--pos) * 100%);
  transform: translate(-50%, -50%);
  width:46px; height:46px; border-radius:9999px; background:#fff;
  border:1px solid rgba(0,0,0,.12);
  box-shadow: 0 8px 20px rgba(0,0,0,.18), inset 0 1px 2px rgba(0,0,0,.08);
  display:flex; align-items:center; justify-content:center;
  cursor: ew-resize; pointer-events:auto; padding:0; line-height:1;
  appearance:none; -webkit-appearance:none;
  z-index: 30; isolation:isolate;
}
#shopify-section-{{ section.id }} .before-after-slider .resizer-trigger svg{
  width:18px; height:18px; opacity:.85; stroke:#111;
}

/* valfritt: “öron” – kan kommenteras bort om de stör */
#shopify-section-{{ section.id }} .before-after-slider .resizer-trigger::before,
#shopify-section-{{ section.id }} .before-after-slider .resizer-trigger::after{
  content:""; position:absolute; top:50%; transform:translateY(-50%);
  width:14px; height:28px; background:#fff; border:1px solid rgba(0,0,0,.12);
  box-shadow:0 4px 10px rgba(0,0,0,.18); z-index: 25;
}
#shopify-section-{{ section.id }} .before-after-slider .resizer-trigger::before{ left:-14px;  border-radius:9999px 0 0 9999px; }
#shopify-section-{{ section.id }} .before-after-slider .resizer-trigger::after { right:-14px; border-radius:0 9999px 9999px 0; }

/* bilder ska inte fånga drag */
#shopify-section-{{ section.id }} .before-after-slider img{
  -webkit-user-drag:none; user-drag:none; pointer-events:none;
}
/* --- Återställ tema-look för linje + bubbla (minimal override) --- */

/* Stäng av vår pseudo-linje så vi ser tema-linjen i .resizer */
#shopify-section-{{ section.id }} .before-after-slider::before{
  display: none !important;
}

/* Gör .resizer till den smala vita linjen, förankrad i --pos */
#shopify-section-{{ section.id }} .before-after-slider .resizer{
  position: absolute !important;
  top: 0 !important;
  bottom: 0 !important;
  left: calc(var(--pos) * 100%) !important;
  transform: translateX(-50%) !important;
  width: 4px !important;
  background: #fff !important;
  z-index: 10 !important;
  pointer-events: none !important;   /* linjen fångar inte klick */
  overflow: visible !important;
}

/* Centrera bubblan över linjen, tema-storlek och stil */
#shopify-section-{{ section.id }} .before-after-slider .resizer-trigger{
  position: absolute !important;
  top: 50% !important;
  left: 50% !important;
  transform: translate(-50%, -50%) !important;
  margin: 0 !important;              /* nollställ -39px från theme.css */
  width: 40px !important;
  height: 40px !important;
  border-radius: 50% !important;
  background: #fff !important;
  border: 1px solid rgba(0,0,0,.12) !important;
  box-shadow: 0 8px 20px rgba(0,0,0,.18), inset 0 1px 2px rgba(0,0,0,.08) !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  cursor: ew-resize !important;
  pointer-events: auto !important;    /* bubblan är klickbar */
  z-index: 30 !important;
}
#shopify-section-{{ section.id }} .before-after-slider .resizer-trigger svg{
  display: block !important;
  width: 18px !important;
  height: 18px !important;
  opacity: .85 !important;
  stroke: #111 !important;
}

/* Mobil: mindre bubbla som i temat */
@media (max-width: 767px){
  #shopify-section-{{ section.id }} .before-after-slider .resizer-trigger{
    width: 40px !important;
    height: 40px !important;
  }
}
/* Fix: gör before-bilden lika stor som after-bilden (neutraliserar theme.css) */
#shopify-section-{{ section.id }} .before-after-slider .before-image{
  position: relative !important;
  width: 100% !important;
  height: auto !important;
  left: 0 !important;
  top: 0 !important;
  overflow: visible !important;
  z-index: 1 !important;
}
/* Fixa before-image även i mobil */
@media (max-width: 767px) {
  #shopify-section-{{ section.id }} .before-after-slider .before-image {
    position: relative !important;
    width: 100% !important;
    height: auto !important;
    left: 0 !important;
    top: 0 !important;
    overflow: visible !important;
    z-index: 1 !important;
  }

  /* Säkerställ att img fyller containern */
  #shopify-section-{{ section.id }} .before-after-slider img {
    width: 100% !important;
    height: auto !important;
    object-fit: cover;
  }
}

/* Se till att slidern och dess barn aldrig går över headern */
#shopify-section-{{ section.id }} .before-after-slider {
  position: relative;   /* redan satt – behåll */
  z-index: 0;           /* ny stacking context på låg nivå */
}

/* Linjen under knoppen */
#shopify-section-{{ section.id }} .before-after-slider .resizer {
  z-index: 1 !important;
}

/* Själva knoppen – sänk från 30 och ta bort isolate */
#shopify-section-{{ section.id }} .before-after-slider .resizer-trigger {
  z-index: 2 !important;
  isolation: auto !important; /* eller ta bort raden helt */
}
#shopify-section-{{ section.id }} .before-after-slider .resizer-trigger {
  z-index: 10 !important;  /* över bilderna/linjen */
}

#shopify-section-{{ section.id }} .before-after-slider .resizer {
  z-index: 9 !important;   /* under knoppen, över bilderna */
}


</style>

<div class="container">
  {%- if ss.title != blank -%}
    <h2 class="title">{{ ss.title }}</h2>
  {%- endif -%}

  {%- if section.blocks.size > 0 -%}
    <div class="sliders">
      {%- for block in section.blocks -%}
        <div class="before-after-slider" {{ block.shopify_attributes }}>
          {%- if block.settings.image_before != blank and block.settings.image_after != blank -%}
            <div class="before-image">
              {{ block.settings.image_before | image_url: width: 1000 | image_tag: loading: 'lazy' }}
            </div>
            <div class="after-image">
              {{ block.settings.image_after  | image_url: width: 1000 | image_tag: loading: 'lazy' }}
            </div>
            <div class="resizer">
              <div class="resizer-trigger">
                {%- render 'icon', type: 'two-carets' -%}
              </div>
            </div>
          {%- endif -%}
        </div>
      {%- endfor -%}
    </div>
  {%- endif -%}
</div>
<script>
(function(){
  const section = document.getElementById('shopify-section-{{ section.id }}');
  if (!section || section.dataset.beforeAfterInit) return;
  section.dataset.beforeAfterInit = '1';

  section.querySelectorAll('.before-after-slider').forEach((slider)=>{
    const setPos = (x)=>{
      const r = slider.getBoundingClientRect();
      let p = (x - r.left) / r.width;
      p = Math.max(0.02, Math.min(0.98, p));   // clamp
      slider.style.setProperty('--pos', p);
    };

    let startX = 0, startY = 0, decided = false, dragging = false;

    const onPointerDown = (e)=>{
      // OBS: ingen preventDefault här
      startX = e.clientX;
      startY = e.clientY;
      decided = false;
      dragging = false;

      const onMove = (ev)=>{
        if (!decided) {
          const dx = Math.abs(ev.clientX - startX);
          const dy = Math.abs(ev.clientY - startY);
          // Tröskel för att avgöra riktning
          if (dx > 6 || dy > 6) {
            decided = true;
            if (dx > dy) {
              // Horisontell avsikt → fånga och blockera scroll
              dragging = true;
              try { slider.setPointerCapture(ev.pointerId); } catch(_) {}
              ev.preventDefault();
            } else {
              // Vertikal avsikt → släpp igenom scroll, städa och lämna
              cleanup();
              return;
            }
          } else {
            return; // för liten rörelse, vänta
          }
        }
        if (dragging) {
          ev.preventDefault(); // blockera vertikal scroll medan vi drar
          setPos(ev.clientX);
        }
      };

      const onUp = (ev)=>{
        cleanup();
      };

      const cleanup = ()=>{
        slider.removeEventListener('pointermove', onMove);
        slider.removeEventListener('pointerup', onUp);
        slider.removeEventListener('pointercancel', onUp);
        try { slider.releasePointerCapture(event.pointerId); } catch(_) {}
      };

      slider.addEventListener('pointermove', onMove, { passive: false });
      slider.addEventListener('pointerup', onUp);
      slider.addEventListener('pointercancel', onUp);
    };

    slider.addEventListener('pointerdown', onPointerDown);

    // init: start i mitten
    const r = slider.getBoundingClientRect();
    setPos(r.left + r.width/2);
  });
})();
</script>


{% schema %}
{
  "name": "Before-After",
  "tag": "section",
  "class": "before-after",
  "settings": [
    { "type": "text", "id": "title", "label": "Title" },
    {
      "type": "range",
      "id": "image_border_radius",
      "label": "Image Border Radius",
      "min": 0, "max": 100, "step": 1, "default": 40, "unit": "px"
    },
    { "type": "header", "content": "Section Padding Settings" },
    { "type": "range", "id": "section_top_padding_desktop", "label": "Top(Desktop)", "min": 0, "max": 160, "step": 4, "default": 120, "unit": "px" },
    { "type": "range", "id": "section_bottom_padding_desktop", "label": "Bottom(Desktop)", "min": 0, "max": 160, "step": 4, "default": 120, "unit": "px" },
    { "type": "range", "id": "section_top_padding_tablet", "label": "Top(Tablet)", "min": 0, "max": 160, "step": 4, "default": 80, "unit": "px" },
    { "type": "range", "id": "section_bottom_padding_tablet", "label": "Bottom(Tablet)", "min": 0, "max": 160, "step": 4, "default": 80, "unit": "px" },
    { "type": "range", "id": "section_top_padding_mobile", "label": "Top(Mobile)", "min": 0, "max": 160, "step": 4, "default": 64, "unit": "px" },
    { "type": "range", "id": "section_bottom_padding_mobile", "label": "Bottom(Mobile)", "min": 0, "max": 160, "step": 4, "default": 64, "unit": "px" }
  ],
  "blocks": [
    {
      "type": "pair",
      "name": "Before/After pair",
      "limit": 3,
      "settings": [
        { "type": "image_picker", "id": "image_before", "label": "Image Before" },
        { "type": "image_picker", "id": "image_after",  "label": "Image After" }
      ]
    }
  ],
  "presets": [
    { "name": "Before-After (up to 3 side-by-side)" }
  ]
}
{% endschema %}
