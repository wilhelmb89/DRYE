{%- comment -%} === Globala routes (behövs av Shopify) === {%- endcomment -%}
<script>
  {% liquid
    if routes.root_url == '/'
      assign base = ''
    else
      assign base = routes.root_url
    endif
  %}
  window.shopUrl = '{{ base }}';
  window.routes = {
    cart_add_url: '{{ routes.cart_add_url }}',
    cart_change_url: '{{ routes.cart_change_url }}',
    cart_update_url: '{{ routes.cart_update_url }}',
    cart_url: '{{ routes.cart_url }}',
    predictive_search_url: '{{ routes.predictive_search_url }}',
  };
</script>

{%- comment -%} === Dina bundles (alltid defer) === {%- endcomment -%}
<script src="{{ 'vendor.js' | asset_url }}" defer></script>
<script src="{{ 'main.bundle.js' | asset_url }}" defer></script>
{%- if assets['theme.min.js'] -%}
  <script src="{{ 'theme.min.js' | asset_url }}" defer></script>
{%- else -%}
  <script src="{{ 'theme.js' | asset_url }}" defer></script>
{%- endif -%}

{%- comment -%} === Hjälpfunktioner för senladdning === {%- endcomment -%}
<script>
  window.loadScript = window.loadScript || function (src) {
    var s = document.createElement('script'); s.src = src; s.defer = true; document.body.appendChild(s);
  };
  window.loadCSS = window.loadCSS || function (href) {
    var l = document.createElement('link'); l.rel = 'stylesheet'; l.href = href; document.head.appendChild(l);
  };
  window.onIdle = window.onIdle || function (cb) {
    if ('requestIdleCallback' in window) requestIdleCallback(cb, {timeout: 3000});
    else setTimeout(cb, 3000);
  };
</script>

{%- comment -%} === Swiper: ladda ENDAST när den finns i DOM (CSS + JS) === {%- endcomment -%}
<script>
  (function () {
    if (!document.querySelector('.swiper, .swiper-container')) return;
    if (!window.Swiper) {
      loadCSS('https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css');
      loadScript('https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js');
    }
  })();
</script>

{%- comment -%} === Sharer: endast på produkt/artikel & när knappar finns === {%- endcomment -%}
{%- if request.page_type == 'product' or request.page_type == 'article' -%}
<script>
  onIdle(function () {
    if (document.querySelector('[data-sharer]')) {
      loadScript('https://cdn.jsdelivr.net/npm/sharer.js@latest/sharer.min.js');
    }
  });
</script>
{%- endif -%}

{%- comment -%} === 3:e-parts: ladda bara vid behov (sist i filen) === {%- endcomment -%}
<script>
  // Judge.me – ladda bara om widget finns
  onIdle(function(){
    if (document.querySelector('.jdgm-widget, .jdgm-carousel, .jdgm-rev-widg')) {
      loadCSS('https://cdnwidget.judge.me/widget_v3/base.css');
      loadCSS('https://cdnwidget.judge.me/widget_v3/main.css');
      loadScript('https://cdnwidget.judge.me/widget_v3/main.js');
    }
  });

  // Clarity – valfritt: byt XXXXXXXX mot din tagg eller ta bort helt om du inte använder
  onIdle(function(){
    if (!window.clarity && !(window.Shopify && Shopify.designMode)) {
      // loadScript('https://www.clarity.ms/tag/XXXXXXXX');
    }
  });
</script>
